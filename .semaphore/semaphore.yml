version: v1.0
name: Dotfiles

agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu2004

execution_time_limit:
  minutes: 5

auto_cancel:
  queued:
    when: true

blocks:
  - name: "Checks"
    task:
      jobs:
      - name: "Install"
        commands:
          # Install the same way I would, from GitHub without cloning first
          - bash <(wget -qO- -o /dev/null https://raw.githubusercontent.com/mortenfyhn/dotfiles/${SEMAPHORE_GIT_SHA}/install-dotfiles.sh)
          # Try sourcing .zshrc succeeds (`zsh -i` does so)
          # and re-run the install script in ZSH to test idempotency
          - echo 'echo "Sourced .zshrc"' >> ~/.zshrc
          - zsh -i -c './install-dotfiles.sh'

      - name: "Shellcheck"
        commands:
          - checkout
            # Apparently shellcheck is pre-installed
          - shellcheck --version
          - shellcheck install-dotfiles.sh

      - name: "Shell format"
        commands:
          - checkout
          - wget https://github.com/patrickvane/shfmt/releases/download/master/shfmt_linux_amd64 -O shfmt
          - chmod +x shfmt
          - ./shfmt --version
          - ./shfmt -i 4 -d install-dotfiles.sh
          - ./shfmt -i 4 -d .zshrc
